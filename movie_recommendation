import tkinter as tk
from tkinter import ttk, messagebox
from PIL import Image, ImageTk
import pandas as pd
import time, os

# ---- Load Dataset ----
movies = pd.read_csv("movies.csv")

# ---- DAA Algorithms ----
def merge_sort(arr, key):
    if len(arr) <= 1:
        return arr
    mid = len(arr)//2
    left = merge_sort(arr[:mid], key)
    right = merge_sort(arr[mid:], key)
    result, i, j = [], 0, 0
    while i < len(left) and j < len(right):
        if str(left[i][key]).lower() < str(right[j][key]).lower():
            result.append(left[i]); i += 1
        else:
            result.append(right[j]); j += 1
    result.extend(left[i:]); result.extend(right[j:])
    return result

# ---- Tkinter UI ----
root = tk.Tk()
root.title("ðŸŽ¬ Movie Recommendation System")
root.geometry("950x700")
root.config(bg="#0B132B")

tk.Label(root, text="ðŸŽ¬ Movie Recommendation System", 
         bg="#0B132B", fg="#00C9A7", font=("Helvetica", 22, "bold")).pack(pady=20)
tk.Label(root, text="Enter a movie name or genre and get similar suggestions ðŸ¿", 
         bg="#0B132B", fg="white", font=("Arial", 12)).pack()

frame = tk.Frame(root, bg="#0B132B")
frame.pack(pady=10)
tk.Label(frame, text="Search:", bg="#0B132B", fg="white", font=("Arial", 12)).grid(row=0, column=0, padx=10)
entry = tk.Entry(frame, width=35, font=("Arial", 12))
entry.grid(row=0, column=1, padx=5)

# ---- Updated Recommend Function ----
def recommend_movies():
    start = time.time()
    query = entry.get().strip().lower()
    if not query:
        messagebox.showwarning("âš ï¸ Input Error", "Please enter a movie name or genre!")
        return

    data = movies.to_dict("records")
    sorted_data = merge_sort(data, "title")

    # Clear old data
    for i in tree.get_children():
        tree.delete(i)
    poster_lbl.config(image="", text="")
    trending_lbl.config(text="")

    found_movie = None
    results = []

    # --- Search by Movie Title ---
    for item in sorted_data:
        if query in str(item["title"]).lower():
            found_movie = item
            break

    # --- If movie found, show similar movies based on its genre ---
    if found_movie:
        genre = str(found_movie.get("genres", "")).strip()
        genre_parts = [g.strip() for g in genre.split(",")]
        for m in sorted_data:
            if m["title"] != found_movie["title"]:
                for g in genre_parts:
                    if g and g.lower() in str(m["genres"]).lower():
                        results.append(m)
                        break
        results = sorted(results, key=lambda x: x.get("rating", 0), reverse=True)[:5]
        tree.insert("", "end", values=(found_movie["title"], found_movie["genres"], found_movie["year"], found_movie["language"], found_movie["rating"]))

    # --- If no movie found, treat query as a Genre search ---
    else:
        for m in sorted_data:
            if query in str(m["genres"]).lower():
                results.append(m)
        results = sorted(results, key=lambda x: x.get("rating", 0), reverse=True)[:10]  # show top 10 by rating
        if not results:
            messagebox.showinfo("Not Found", f"No movies found for '{query}'.")
            time_lbl.config(text="")
            return

    # --- Display results ---
    for m in results:
        tree.insert("", "end", values=(m["title"], m["genres"], m["year"], m["language"], m["rating"]))

    end = time.time()
    time_lbl.config(
        text=f"âœ… Found {len(results)} matches for '{query}' | Time: {round(end - start, 4)} sec (O(n log n))"
    )

# ---- Poster Display ----
def show_poster():
    selected = tree.focus()
    if not selected:
        messagebox.showwarning("âš ï¸ No Selection", "Please select a movie first!")
        return
    title = tree.item(selected)["values"][0]
    path = movies.loc[movies["title"] == title, "poster"].values[0]
    try:
        if not os.path.exists(path):
            raise FileNotFoundError
        img = Image.open(path).resize((200, 300))
        img_tk = ImageTk.PhotoImage(img)
        poster_lbl.config(image=img_tk, text="")
        poster_lbl.image = img_tk
    except Exception:
        poster_lbl.config(image="", text="âŒ Poster not found", fg="white", bg="#0B132B", font=("Arial", 12))

# ---- Clear and Trending ----
def clear_all():
    entry.delete(0, tk.END)
    for i in tree.get_children():
        tree.delete(i)
    poster_lbl.config(image="", text="")
    time_lbl.config(text="")
    trending_lbl.config(text="")

def show_trending():
    """Display top 5 movies by rating automatically on startup."""
    data = movies.sort_values(by="rating", ascending=False).head(5)
    for i in tree.get_children():
        tree.delete(i)
    trending_lbl.config(text="ðŸ”¥ Top 5 Trending Movies ðŸ”¥", fg="#FFD700", bg="#0B132B", font=("Arial", 14, "bold"))
    for _, m in data.iterrows():
        tree.insert("", "end", values=(m["title"], m["genres"], m["year"], m["language"], m["rating"]))

# ---- Buttons ----
tk.Button(frame, text="ðŸŽ¯ Recommend", command=recommend_movies, bg="#00C9A7", fg="black",
          font=("Arial", 10, "bold")).grid(row=0, column=2, padx=10)
tk.Button(frame, text="ðŸ§¹ Clear", command=clear_all, bg="#1F4068", fg="white",
          font=("Arial", 10, "bold")).grid(row=0, column=3, padx=10)

# ---- Trending Label ----
trending_lbl = tk.Label(root, bg="#0B132B")
trending_lbl.pack(pady=5)

# ---- Table ----
cols = ("Title", "Genre", "Year", "Language", "Rating")
tree = ttk.Treeview(root, columns=cols, show="headings", height=8)
for c in cols:
    tree.heading(c, text=c)
    tree.column(c, width=150)
tree.pack(pady=10)

# ---- Poster Display ----
tk.Button(root, text="ðŸŽž Show Poster", command=show_poster, bg="#00C9A7",
          fg="black", font=("Arial", 10, "bold")).pack()
poster_lbl = tk.Label(root, bg="#0B132B")
poster_lbl.pack(pady=10)

# ---- Info ----
time_lbl = tk.Label(root, text="", bg="#0B132B", fg="#00C9A7", font=("Arial", 11))
time_lbl.pack(pady=5)
tk.Label(root, text="Mini Project - Integration of AI & DAA Concepts", bg="#0B132B", 
         fg="gray", font=("Arial", 9, "italic")).pack(side="bottom", pady=10)

# ---- Show Trending Movies at Startup ----
root.after(1000, show_trending)

root.mainloop()
